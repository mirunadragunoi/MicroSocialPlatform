@model MicroSocialPlatform.Models.ApplicationUser

@{
    ViewData["Title"] = $"Profil - {Model.FullName}";
    var user = ViewBag.User as MicroSocialPlatform.Models.ApplicationUser;
    var isOwnProfile = ViewBag.IsOwnProfile;
    var canViewProfile = ViewBag.CanViewProfile;
    var postsCount = ViewBag.PostsCount;
    var followersCount = ViewBag.FollowersCount;
    var followingCount = ViewBag.FollowingCount;
    var isFollowing = ViewBag.IsFollowing;
    var isPending = ViewBag.IsPending;
    var posts = ViewBag.Posts as List<MicroSocialPlatform.Models.Post>;
}

<style>
    .btn-accept-gradient {
        background: linear-gradient(90deg, #9d50bb 0%, #ff6b6b 100%);
        color: white !important;
        border: none;
        transition: transform 0.2s, box-shadow 0.2s;
    }

        .btn-accept-gradient:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(157, 80, 187, 0.3);
            opacity: 0.95;
        }

    .btn-decline-outline {
        background-color: white;
        color: #dc3545;
        border: 1px solid #e9ecef;
        transition: all 0.2s;
    }

        .btn-decline-outline:hover {
            background-color: #fff5f5;
            border-color: #dc3545;
            color: #c82333;
        }
</style>

<div class="profile-cover" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); height: 300px; position: relative;">
    @if (!string.IsNullOrEmpty(user.CoverPhoto))
    {
        <img src="@user.CoverPhoto" alt="Cover Photo" style="width: 100%; height: 100%; object-fit: cover;">
    }
</div>

<div class="container">
    <div class="profile-header" style="margin-top: -80px; position: relative; z-index: 10;">
        <div class="row">
            <div class="col-md-12">
                <div class="card shadow-sm">
                    <div class="card-body p-4">
                        <div class="row align-items-center">
                            <div class="col-md-3 text-center">
                                @if (!string.IsNullOrEmpty(user.ProfilePicture))
                                {
                                    <img src="@user.ProfilePicture" alt="@user.FullName" class="rounded-circle border border-4 border-white shadow" style="width: 150px; height: 150px; object-fit: cover;">
                                }
                                else
                                {
                                    <div class="rounded-circle border border-4 border-white shadow bg-secondary text-white d-flex align-items-center justify-content-center mx-auto" style="width: 150px; height: 150px; font-size: 4rem;">
                                        @user.FullName?.Substring(0, 1).ToUpper()
                                    </div>
                                }
                            </div>

                            <div class="col-md-9">
                                <div class="d-flex justify-content-between align-items-start mb-3">
                                    <div>
                                        <h2 class="mb-1">
                                            @user.FullName
                                        </h2>
                                        @if (!string.IsNullOrEmpty(user.CustomUsername))
                                        {
                                            <p class="text-muted mb-2">@@@user.CustomUsername</p>
                                        }

                                        @if (!string.IsNullOrEmpty(user.Status) || !string.IsNullOrEmpty(user.StatusEmoji))
                                        {
                                            <div class="badge bg-light text-dark border mb-2">
                                                @if (!string.IsNullOrEmpty(user.StatusEmoji))
                                                {
                                                    <span style="font-size: 1.2rem;">@user.StatusEmoji</span>
                                                }
                                                @user.Status
                                            </div>
                                        }
                                    </div>

                                    <div class="d-flex flex-column align-items-end gap-2">

                                        @if (ViewBag.IncomingRequestId != null)
                                        {
                                            <div class="card border-0 shadow-sm px-4 py-3 mb-2 bg-white rounded-4" style="min-width: 320px;">
                                                <div class="d-flex flex-column gap-2">
                                                    <div class="d-flex align-items-center text-muted fw-bold small mb-1">
                                                        <i class="bi bi-person-plus-fill text-primary me-2"></i>
                                                        <span>Vrea să te urmărească:</span>
                                                    </div>

                                                    <div class="d-flex gap-2 w-100">
                                                        <form asp-controller="Profile" asp-action="AcceptRequestFromProfile" method="post" class="flex-grow-1 m-0">
                                                            <input type="hidden" name="requestId" value="@ViewBag.IncomingRequestId" />

                                                            <input type="hidden" name="returnUrl" value="@Context.Request.Path@Context.Request.QueryString" />

                                                            <button type="submit" class="btn btn-accept-gradient btn-sm w-100 fw-bold rounded-pill py-2">
                                                                Acceptă
                                                            </button>
                                                        </form>

                                                        <form asp-controller="Profile" asp-action="DeclineRequestFromProfile" method="post" class="flex-grow-1 m-0">
                                                            <input type="hidden" name="requestId" value="@ViewBag.IncomingRequestId" />

                                                            <input type="hidden" name="returnUrl" value="@Context.Request.Path@Context.Request.QueryString" />

                                                            <button type="submit" class="btn btn-decline-outline btn-sm w-100 fw-bold rounded-pill py-2">
                                                                Șterge
                                                            </button>
                                                        </form>
                                                    </div>
                                                </div>
                                            </div>
                                        }
                                        @if (isOwnProfile)
                                        {
                                            <a asp-action="Edit" class="btn btn-outline-primary">
                                                <i class="bi bi-pencil-square me-2"></i>Editează Profilul
                                            </a>
                                        }
                                        else if (ViewBag.IsAuthenticated)
                                        {
                                            <div class="d-flex gap-2">
                                                <button type="button"
                                                        class="btn follow-btn rounded-pill px-4 fw-bold @(isFollowing ? "btn-outline-primary" : (isPending ? "btn-light border" : "btn-primary text-white"))"
                                                        style="@(isPending ? "color: #6c757d;" : "")"
                                                        data-user-id="@user.Id">

                                                    @if (isFollowing)
                                                    {
                                                        <span><i class="bi bi-person-check-fill me-1"></i> Urmărești</span>
                                                    }
                                                    else if (isPending)
                                                    {
                                                        <span><i class="bi bi-clock-history me-1"></i> Cerere trimisă</span>
                                                    }
                                                    else
                                                    {
                                                        <span><i class="bi bi-person-plus-fill me-1"></i> Urmărește</span>
                                                    }
                                                </button>

                                            </div>
                                        }
                                        else
                                        {
                                            <div class="alert alert-info rounded-pill border-0 d-inline-block mb-0" style="background: rgba(142, 68, 173, 0.1); padding: 0.5rem 1rem;">
                                                <div class="d-flex align-items-center gap-2">
                                                    <i class="bi bi-info-circle"></i>
                                                    <span class="small">
                                                        Pentru a urmări utilizatori, <a asp-area="Identity" asp-page="/Account/Register" class="text-decoration-none fw-bold">creează un cont</a> sau
                                                        <a asp-area="Identity" asp-page="/Account/Login" class="text-decoration-none fw-bold">autentifică-te</a>.
                                                    </span>
                                                </div>
                                            </div>
                                        }
                                    </div>
                                </div>

                                <div class="row text-center mb-3">
                                    <div class="col-4">
                                        <h4 class="mb-0 fw-bold" id="posts-count">@postsCount</h4>
                                        <small class="text-muted">Postări</small>
                                    </div>

                                    <div class="col-4" style="cursor: pointer;" onclick="openFollowModal('@user.Id', 'followers')">
                                        <h4 class="mb-0 fw-bold" id="followers-count">@followersCount</h4>
                                        <small class="text-muted text-primary-hover">Urmăritori</small>
                                    </div>

                                    <div class="col-4" style="cursor: pointer;" onclick="openFollowModal('@user.Id', 'following')">
                                        <h4 class="mb-0 fw-bold">@followingCount</h4>
                                        <small class="text-muted text-primary-hover">Urmăriri</small>
                                    </div>
                                </div>

                                @if (!string.IsNullOrEmpty(user.Bio))
                                {
                                    <p class="mb-2">@user.Bio</p>
                                }

                                <div class="small text-muted">
                                    @if (!string.IsNullOrEmpty(user.Location))
                                    {
                                        <span class="me-3">
                                            <i class="bi bi-geo-alt-fill"></i> @user.Location
                                        </span>
                                    }
                                    @if (!string.IsNullOrEmpty(user.Website))
                                    {
                                        <span class="me-3">
                                            <i class="bi bi-link-45deg"></i>
                                            <a href="@user.Website" target="_blank" class="text-decoration-none">@user.Website</a>
                                        </span>
                                    }
                                    <span>
                                        <i class="bi bi-calendar3"></i> Membru din @user.CreatedAt.ToString("MMMM yyyy")
                                    </span>
                                </div>

                                @if (!user.IsPublic)
                                {
                                    <div class="d-flex align-items-center justify-content-center p-3 mt-3 rounded-4 shadow-sm"
                                         style="background-color: #f3e5f5; color: #8e44ad; border: 1px solid rgba(142, 68, 173, 0.2);">
                                        <i class="bi bi-lock-fill fs-5 me-2"></i>
                                        <span>
                                            <strong>Profil Privat</strong> - Doar urmăritorii aprobați pot vedea postările.
                                        </span>
                                    </div>
                                }

                                @if (!user.IsPublic && User.IsInRole("Administrator") && !isOwnProfile)
                                {
                                    <div class="d-flex align-items-center justify-content-center p-3 mt-3 rounded-4 shadow-sm"
                                         style="background-color: #fff3cd; color: #856404; border: 1px solid #ffc107;">
                                        <i class="bi bi-shield-fill-check fs-5 me-2"></i>
                                        <span>
                                            <strong>Mod Administrator</strong> - Vizualizezi un profil privat cu drepturi de admin.
                                        </span>
                                    </div>
                                }
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="mt-4 mb-5">
        @if (!canViewProfile)
        {
            <div class="text-center py-5">
                <i class="bi bi-lock-fill text-muted" style="font-size: 4rem;"></i>
                <h3 class="mt-3">Acest profil este privat</h3>
                <p class="text-muted">Urmărește acest utilizator pentru a vedea postările.</p>
            </div>
        }
        else if (posts == null || !posts.Any())
        {
            <div class="text-center py-5">
                <i class="bi bi-camera text-muted" style="font-size: 4rem;"></i>
                <h3 class="mt-3">Încă nu sunt postări</h3>
                @if (isOwnProfile)
                {
                    <p class="text-muted">Creează prima ta postare!</p>
                    <a asp-controller="Post" asp-action="Create" class="btn btn-primary mt-2">
                        <i class="bi bi-plus-circle me-2"></i>Creează Postare
                    </a>
                }
            </div>
        }
        else
        {
            <div class="row g-3">
                @foreach (var post in posts)
                {
                    <div class="col-6 col-md-4">
                        <partial name="_PostGridCard" model="post" />
                    </div>
                }
            </div>
        }
    </div>
</div>

<div class="modal fade" id="followModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content rounded-4 shadow">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title fw-bold" id="followModalTitle">Listă</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="followModalBody">
                <div class="text-center py-4">
                    <div class="spinner-border text-primary" role="status"></div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // follow/unfollow functionality
        document.querySelectorAll('.follow-btn').forEach(btn => {
            btn.addEventListener('click', async function() {
                const userId = this.dataset.userId;
                const button = this;

                // blocam butonul cat timp se face cererea la server
                button.disabled = true;

                try {
                    const response = await fetch('@Url.Action("ToggleFollow", "Profile")', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                            'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value
                        },
                        body: `userId=${userId}`
                    });

                    const data = await response.json();

                    if (data.success) {
                        // actualizam numarul de urmaritori
                        const followersElement = document.getElementById('followers-count');
                        if(followersElement) {
                            followersElement.textContent = data.followersCount;
                        }

                        button.className = 'btn follow-btn rounded-pill px-4 fw-bold'; // Resetam clasele
                        button.style.color = '';

                        // aplicam starea noua
                        if (data.isFollowing) {
                            // acum il urmaresti (Accepted)
                            button.classList.add('btn-outline-primary');
                            button.innerHTML = '<span><i class="bi bi-person-check-fill me-1"></i> Urmărește</span>';
                        }
                        else if (data.isPending) {
                            // cerere trimisa (Pending)
                            button.classList.add('btn-light', 'border');
                            button.style.color = '#6c757d';
                            button.innerHTML = '<span><i class="bi bi-clock-history me-1"></i> Cerere trimisă</span>';
                        }
                        else {
                            // nu il urmaresti (Unfollow/Cancel)
                            button.classList.add('btn-primary', 'text-white');
                            button.innerHTML = '<span><i class="bi bi-person-plus-fill me-1"></i> Urmărește</span>';
                        }

                    } else {
                        alert(data.message);
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert('A apărut o eroare.');
                } finally {
                    button.disabled = false;
                }
            });
        });

        function openFollowModal(userId, type) {
            const title = type === 'followers' ? 'Urmăritori' : 'Urmăriri';
            document.getElementById('followModalTitle').innerText = title;

            // deschidem modala
            const modalElement = document.getElementById('followModal');

            document.body.appendChild(modalElement);

            const modal = new bootstrap.Modal(modalElement);
            modal.show();

            document.getElementById('followModalBody').innerHTML = `
                <div class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>`;

            const url = type === 'followers'
                ? '@Url.Action("GetFollowersList", "Profile")'
                : '@Url.Action("GetFollowingList", "Profile")';

            fetch(`${url}?userId=${userId}`)
                .then(response => response.text())
                .then(html => {
                    document.getElementById('followModalBody').innerHTML = html;
                })
                .catch(error => {
                    document.getElementById('followModalBody').innerHTML = '<p class="text-danger text-center">Eroare la încărcare.</p>';
                });
        }
    </script>
}