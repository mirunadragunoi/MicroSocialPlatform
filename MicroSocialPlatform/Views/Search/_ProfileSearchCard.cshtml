@model MicroSocialPlatform.Models.ViewModels.SearchResultViewModel
@using System.Text.RegularExpressions

@{
    var searchQuery = ViewBag.Query as string ?? "";

    string Highlight(string text)
    {
        if (string.IsNullOrEmpty(text) || string.IsNullOrEmpty(searchQuery)) return text;
        try
        {
            return Regex.Replace(text, Regex.Escape(searchQuery),
                match => $"<span class='fw-bold' style='color: #8e44ad;'>{match.Value}</span>",
                RegexOptions.IgnoreCase);
        }
        catch { return text; }
    }

    var userInitials = "AN";
    if (!string.IsNullOrEmpty(Model.FullName))
    {
        userInitials = Model.FullName.Substring(0, Math.Min(2, Model.FullName.Length)).ToUpper();
    }
}

<a asp-controller="Profile" asp-action="Index" asp-route-username="@Model.Username" class="text-decoration-none">
    <div class="card border-0 shadow-sm rounded-4 profile-search-card h-100 position-relative"
         style="transition: all 0.3s; cursor: pointer;"
         onmouseover="this.style.transform='translateY(-5px)'; this.style.boxShadow='0 10px 25px rgba(0,0,0,0.15)'"
         onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 10px rgba(0,0,0,0.1)'">

        <div class="position-absolute top-0 end-0 m-2">
            @if (Model.IsPublic)
            {
                <span class="badge bg-white text-success border shadow-sm" title="Profil Public"><i class="bi bi-globe"></i></span>
            }
            else
            {
                <span class="badge bg-white text-warning border shadow-sm" title="Profil Privat"><i class="bi bi-lock-fill"></i></span>
            }
        </div>

        <div class="profile-cover-mini"
             style="height: 80px;
                    background: linear-gradient(135deg, #a18cd1 0%, #fbc2eb 100%);
                    border-top-left-radius: var(--bs-border-radius-xl);
                    border-top-right-radius: var(--bs-border-radius-xl);">
        </div>

        <div class="card-body text-center pb-3">
            <div class="position-relative d-inline-block mb-2" style="margin-top: -40px;">
                <div class="profile-picture-mini" style="width: 80px; height: 80px; border-radius: 50%; border: 4px solid white; background: linear-gradient(135deg, #a18cd1, #fbc2eb); display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 1.5rem; box-shadow: 0 4px 10px rgba(0,0,0,0.2);">
                    @if (!string.IsNullOrEmpty(Model.ProfilePicture))
                    {
                        <img src="@Model.ProfilePicture" alt="Profile" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">
                    }
                    else
                    {
                        <span>@userInitials</span>
                    }
                </div>
            </div>

            <h5 class="mb-1 text-dark fw-bold text-truncate px-2">
                @Html.Raw(Highlight(Model.FullName))
            </h5>

            <p class="text-muted mb-2 small">
                @@@Html.Raw(Highlight(Model.Username))
            </p>

            @if (!string.IsNullOrEmpty(Model.Bio))
            {
                <p class="text-muted small mb-0 px-2" style="font-size: 0.85rem; overflow: hidden; text-overflow: ellipsis; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; min-height: 2.6em;">
                    @Html.Raw(Highlight(Model.Bio))
                </p>
            }
            else
            {
                <p class="small mb-0" style="min-height: 2.6em;">&nbsp;</p>
            }

            <div class="mt-3">
                @if (Model.IsCurrentUser)
                {
                    <span class="btn btn-sm btn-secondary rounded-pill px-4 w-75 disabled" style="opacity: 0.7; font-weight: 600;">
                        Tu
                    </span>
                }
                else if (Model.IsFollowing)
                {
                    <span class="btn btn-sm rounded-pill px-4 w-75 fw-bold text-white shadow-sm"
                          style="background: linear-gradient(90deg, #9d50bb 0%, #ff6b6b 100%); border: none;">
                        <i class="bi bi-check-circle-fill me-1"></i> Urmaresti
                    </span>
                }
                else if (Model.IsPending)
                {
                    <span class="btn btn-sm rounded-pill px-4 w-75 fw-bold"
                          style="background-color: #f3e5f5; color: #9d50bb; border: 1px solid #e1bee7;">
                        <i class="bi bi-clock-history me-1"></i> In asteptare
                    </span>
                }
                else
                {
                    <span class="btn btn-sm btn-outline-primary rounded-pill px-4 w-75 fw-bold">Vezi Profil</span>
                }
            </div>
        </div>
    </div>
</a>