@model IEnumerable<MicroSocialPlatform.Models.Notification>

@{
    ViewData["Title"] = "Notificări";
    var unreadCount = Model.Count(n => !n.IsRead);
    var readCount = Model.Count(n => n.IsRead);
    var totalCount = Model.Count();
}

<div id="successAlert" class="success-alert-container" style="display: none;">
    <div class="success-alert shadow rounded-4 d-flex align-items-center bg-white">
        <div class="alert-icon-wrapper me-3">
            <i class="bi bi-check-circle-fill" style="color: #a18cd1; font-size: 1.5rem;"></i>
        </div>
        <div class="flex-grow-1">
            <h6 class="mb-0 fw-bold" style="color: #6c757d;">Succes</h6>
            <div id="alertMessage" class="text-muted small">Operațiune reușită!</div>
        </div>
        <button type="button" class="btn btn-link text-muted p-0 ms-3" onclick="closeSuccessAlert()">
            <i class="bi bi-x-lg"></i>
        </button>
    </div>
</div>

<div class="container mt-4" style="max-width: 850px;">

    <div class="card border-0 shadow-sm rounded-4 mb-4">
        <div class="card-body p-4">
            <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
                <div>
                    <h2 class="mb-2 fw-bold" style="color: #4a4a4a;">
                        <i class="bi bi-bell-fill me-2" style="color: #a18cd1;"></i>Notificări
                    </h2>

                    <div class="d-flex gap-2">
                        <span class="badge rounded-pill px-3 py-2 d-flex align-items-center gap-2"
                              style="background-color: rgba(161, 140, 209, 0.15); color: #8e44ad; border: 1px solid rgba(161, 140, 209, 0.2);">
                            <span class="d-inline-block rounded-circle" style="width: 6px; height: 6px; background-color: #8e44ad;"></span>
                            <span id="badgeUnread">@unreadCount</span> necitite
                        </span>

                        <span class="badge rounded-pill px-3 py-2 text-muted bg-light border">
                            <span id="badgeRead">@readCount</span> citite
                        </span>

                        <span class="badge rounded-pill px-3 py-2 text-muted bg-white border">
                            <span id="badgeTotal">@totalCount</span> total
                        </span>
                    </div>
                </div>

                <div class="d-flex gap-2">
                    @if (unreadCount > 0)
                    {
                        <button class="btn btn-light rounded-pill border px-3 text-muted hover-purple" id="markAllRead" title="Marchează tot ca citit">
                            <i class="bi bi-check2-all me-1"></i> <span class="d-none d-sm-inline">Citește tot</span>
                        </button>
                    }
                    @if (Model.Any())
                    {
                        <button class="btn btn-light rounded-pill border px-3 text-danger hover-red" id="deleteAll" title="Șterge tot istoricul">
                            <i class="bi bi-trash3 me-1"></i> <span class="d-none d-sm-inline">Șterge tot</span>
                        </button>
                    }
                </div>
            </div>
        </div>
    </div>

    @if (!Model.Any())
    {
        <div class="card border-0 shadow-sm rounded-4">
            <div class="card-body text-center py-5">
                <div class="mb-3">
                    <i class="bi bi-bell-slash text-muted opacity-25" style="font-size: 4rem;"></i>
                </div>
                <h5 class="text-muted fw-bold">Nu ai notificări noi</h5>
                <p class="text-muted small">Când cineva interacționează cu tine, va apărea aici.</p>
            </div>
        </div>
    }
    else
    {
        <div class="list-group shadow-sm rounded-4 overflow-hidden border-0">
            @foreach (var notification in Model)
            {
                var isUnread = !notification.IsRead;
                var iconClass = "bi-bell-fill";
                var gradient = "linear-gradient(135deg, #a18cd1, #fbc2eb)"; 

                if (notification.Type == NotificationType.Like) { iconClass = "bi-heart-fill"; gradient = "linear-gradient(135deg, #ff9a9e, #fecfef)"; }
                else if (notification.Type == NotificationType.Comment) { iconClass = "bi-chat-dots-fill"; gradient = "linear-gradient(135deg, #a18cd1, #fbc2eb)"; }
                else if (notification.Type == NotificationType.Follow) { iconClass = "bi-person-plus-fill"; gradient = "linear-gradient(135deg, #84fab0, #8fd3f4)"; }
                else if (notification.Type == NotificationType.FollowRequest) { iconClass = "bi-person-fill-exclamation text-warning"; gradient = "linear-gradient(135deg, #84fab0, #8fd3f4)"; }
                else if (notification.Type == NotificationType.FollowAccepted) { iconClass = "bi-check-circle-fill text-success"; gradient = "linear-gradient(135deg, #a18cd1, #fbc2eb)"; }
                else if (notification.Type == NotificationType.GroupJoinRequest) { iconClass = "bi-people-fill text-primary"; gradient = "linear-gradient(135deg, #84fab0, #8fd3f4)"; }
                else if (notification.Type == NotificationType.GroupJoinAccepted) { iconClass = "bi-check-circle-fill text-success"; gradient = "linear-gradient(135deg, #84fab0, #8fd3f4)"; }
                else if (notification.Type == NotificationType.PostDeleted) { iconClass = "bi-trash-fill text-danger"; gradient = "linear-gradient(135deg, #a18cd1, #fbc2eb)"; }
                else if (notification.Type == NotificationType.CommentDeleted) { iconClass = "bi-trash-fill text-warning"; gradient = "linear-gradient(135deg, #84fab0, #8fd3f4)"; }
                else if (notification.Type == NotificationType.GroupDeleted) { iconClass = "bi-x-circle-fill text-danger"; gradient = "linear-gradient(135deg, #84fab0, #8fd3f4)"; }


                <a href="@notification.RelatedUrl"
                   class="list-group-item list-group-item-action notification-item p-3 border-0 border-bottom @(isUnread ? "notification-unread" : "notification-read")"
                   data-notification-id="@notification.Id"
                   style="transition: background-color 0.2s;">

                    <div class="d-flex w-100 align-items-center gap-3">

                        <div class="flex-shrink-0 position-relative">
                            <div class="rounded-circle d-flex align-items-center justify-content-center text-white shadow-sm notification-icon-circle"
                                 style="width: 48px; height: 48px; background: @gradient;">
                                <i class="@iconClass fs-5"></i>
                            </div>
                            @if (isUnread)
                            {
                                <span class="position-absolute top-0 start-100 translate-middle p-1 bg-danger border border-light rounded-circle unread-dot"></span>
                            }
                        </div>

                        <div class="flex-grow-1">
                            <div class="d-flex justify-content-between align-items-start">
                                <p class="mb-1 text-dark @(isUnread ? "fw-bold" : "")" style="font-size: 0.95rem; line-height: 1.4;">
                                    @if (notification.Sender != null)
                                    {
                                        <span class="text-primary">@notification.Sender.UserName</span>
                                    }
                                    @notification.Content.Replace(notification.Sender?.UserName ?? "", "")
                                </p>

                                <button class="btn btn-link text-muted p-0 ms-2 delete-notification opacity-50 hover-opacity-100"
                                        data-notification-id="@notification.Id"
                                        title="Șterge">
                                    <i class="bi bi-x-lg"></i>
                                </button>
                            </div>

                            <small class="text-muted d-flex align-items-center gap-1">
                                <i class="bi bi-clock"></i> @GetTimeAgo(notification.CreatedAt)
                            </small>
                        </div>
                    </div>
                </a>
            }
        </div>
    }
</div>

@functions {
    string GetTimeAgo(DateTime date)
    {
        var timeSpan = DateTime.UtcNow - date;
        if (timeSpan.TotalMinutes < 1) return "Acum";
        if (timeSpan.TotalMinutes < 60) return $"Acum {(int)timeSpan.TotalMinutes}m";
        if (timeSpan.TotalHours < 24) return $"Acum {(int)timeSpan.TotalHours}h";
        if (timeSpan.TotalDays < 7) return $"Acum {(int)timeSpan.TotalDays}z";
        return date.ToString("dd MMM");
    }
}

<style>
    .success-alert-container {
        position: fixed;
        top: 90px;
        right: 20px; 
        z-index: 9999;
        min-width: 300px;
        animation: slideInRight 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }

    .success-alert {
        border-left: 5px solid #a18cd1 !important; 
        padding: 1rem 1.2rem;
    }

    .notification-unread {
        background-color: #fbf7ff !important; 
        border-left: 4px solid #a18cd1 !important;
    }

        .notification-unread:hover {
            background-color: #f3eafd !important;
        }

    .notification-read {
        background-color: #ffffff;
        border-left: 4px solid transparent !important;
    }

        .notification-read:hover {
            background-color: #f8f9fa;
        }

        .notification-read .notification-icon-circle {
            opacity: 0.6; 
            filter: grayscale(30%);
        }

    /* animatii */
    @@keyframes slideInRight {
        from {
            transform: translateX(100%);
            opacity: 0;
        }

        to {
            transform: translateX(0);
            opacity: 1;
        }
    }

    @@keyframes fadeOut {
        from {
            opacity: 1;
        }

        to {
            opacity: 0;
        }
    }

    .hover-purple:hover {
        background-color: #f3eafd;
        color: #8e44ad !important;
        border-color: #a18cd1 !important;
    }

    .hover-red:hover {
        background-color: #fff5f5;
        color: #dc3545 !important;
        border-color: #dc3545 !important;
    }

    .hover-opacity-100:hover {
        opacity: 1 !important;
    }

</style>

@section Scripts {
    <script>
        // functii pentru alerta de succes
        function showSuccessAlert(message) {
            const alertContainer = document.getElementById('successAlert');
            const alertMessage = document.getElementById('alertMessage');

            alertMessage.textContent = message;
            alertContainer.style.display = 'block';

            alertContainer.style.animation = 'none';
            alertContainer.offsetHeight; 
            alertContainer.style.animation = 'slideInRight 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275)';

            // mesajul dispare dupa 4 secunde
            setTimeout(() => { closeSuccessAlert(); }, 4000);
        }

        function closeSuccessAlert() {
            const alertContainer = document.getElementById('successAlert');
            alertContainer.style.transition = 'opacity 0.5s ease, transform 0.5s ease';
            alertContainer.style.opacity = '0';
            alertContainer.style.transform = 'translateX(50px)';

            setTimeout(() => {
                alertContainer.style.display = 'none';
                alertContainer.style.opacity = '1';
                alertContainer.style.transform = 'none';
            }, 500);
        }

        document.addEventListener('DOMContentLoaded', function() {

            // marcheaza tot ca citit
            const markAllBtn = document.getElementById('markAllRead');
            if (markAllBtn) {
                markAllBtn.addEventListener('click', function() {
                    fetch('/Notification/MarkAllAsRead', { method: 'POST' })
                    .then(r => r.json())
                    .then(data => {
                        if (data.success) {
                            showSuccessAlert('Toate notificările au fost citite! ✓');

                            document.querySelectorAll('.notification-unread').forEach(item => {
                                item.classList.remove('notification-unread');
                                item.classList.add('notification-read');
                                item.querySelector('.unread-dot')?.remove();
                            });
                            updateHeaderBadges(0);
                        }
                    });
                });
            }

            // sterge tot istoricul
            const deleteAllBtn = document.getElementById('deleteAll');
            if (deleteAllBtn) {
                deleteAllBtn.addEventListener('click', function() {
                    if (confirm('Sigur vrei să ștergi tot istoricul?')) {
                        fetch('/Notification/DeleteAll', { method: 'POST' })
                        .then(r => r.json())
                        .then(data => {
                            if (data.success) {
                                showSuccessAlert('Istoricul a fost șters complet! 🗑️');

                                // asteptam 3 secunde si reincarcam pagina
                                setTimeout(() => {
                                    location.reload();
                                }, 3000);
                            }
                        });
                    }
                });
            }

            // stergere notificare individuala
            document.querySelectorAll('.delete-notification').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.preventDefault(); e.stopPropagation();
                    const id = this.dataset.notificationId;
                    const item = this.closest('.notification-item');

                    fetch('/Notification/Delete/' + id, { method: 'POST' })
                    .then(r => r.json())
                    .then(data => {
                        if (data.success) {
                            item.style.transition = 'all 0.4s ease';
                            item.style.transform = 'translateX(100px)';
                            item.style.opacity = '0';

                            setTimeout(() => item.remove(), 400);
                            showSuccessAlert('Notificare ștearsă.');
                        }
                    });
                });
            });

            // click pe notificare pentru a o marca ca citita
            document.querySelectorAll('.notification-item').forEach(item => {
                item.addEventListener('click', function(e) {
                    if (e.target.closest('.delete-notification')) return;
                    e.preventDefault();

                    const id = this.dataset.notificationId;
                    const url = this.getAttribute('href');

                    if (this.classList.contains('notification-read')) {
                        window.location.href = url;
                        return;
                    }

                    fetch('/Notification/MarkAsRead?id=' + id, { method: 'POST' })
                    .then(() => window.location.href = url);
                });
            });

            function updateHeaderBadges(unreadCount) {
                const badgeUnread = document.getElementById('badgeUnread');
                if(badgeUnread) badgeUnread.textContent = unreadCount;
            }
        });
    </script>
}